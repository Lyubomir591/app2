name: Android Build (Debug)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Тип сборки'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_TYPE: ${{ github.event.inputs.build_type || 'debug' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git openjdk-17-jdk \
            libncurses5 zlib1g-dev libffi-dev libssl-dev \
            autoconf automake libtool pkg-config cmake \
            unzip libgstreamer1.0 gstreamer1.0-plugins-base
            
      - name: Install Python packages
        run: |
          pip install --upgrade pip
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1 pillow requests
          
      - name: Verify buildozer.spec
        run: |
          if [ ! -f buildozer.spec ]; then
            echo "ERROR: buildozer.spec not found!"
            exit 1
          fi
          grep "android.accept_sdk_license = True" buildozer.spec || echo "android.accept_sdk_license = True" >> buildozer.spec
          
      - name: Build APK (DEBUG)
        run: buildozer -v android debug
        
      - name: Find APK
        id: find-apk
        run: |
          APK=$(find . -name "*-debug.apk" -type f | head -1)
          if [ -z "$APK" ]; then
            echo "APK not found!"
            ls -la bin/
            exit 1
          fi
          echo "apk_path=$APK" >> $GITHUB_OUTPUT
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: ${{ steps.find-apk.outputs.apk_path }}
