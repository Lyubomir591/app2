name: Android Build Pipeline (2026)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Тип сборки'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      clean_build:
        description: 'Полная очистка перед сборкой'
        required: false
        default: false
        type: boolean

env:
  APP_NAME: "OrderManager"
  PACKAGE_NAME: "org.ordermanager.ordermanager"
  BUILD_TOOLS_VERSION: "34.0.0"
  PYTHON_VERSION: "3.11"
  BUILDOZER_VERSION: "1.5.0"

jobs:
  validate:
    name: Валидация кода
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Установка Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Установка зависимостей
        run: |
          pip install --upgrade pip
          pip install flake8 pyflakes
          flake8 . --exclude=.buildozer,bin,.git --max-line-length=120
      
      - name: Проверка синтаксиса JSON
        run: |
          find . -name "*.json" -type f -exec python -m json.tool {} \; > /dev/null || exit 1

  build-android:
    name: Сборка APK/AAB
    needs: validate
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout кода
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Кэширование зависимостей Python
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local/bin
          key: ${{ runner.os }}-py-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-py-${{ env.PYTHON_VERSION }}-

      - name: Установка системных зависимостей
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git \
            cmake \
            autoconf \
            libtool \
            pkg-config \
            libssl-dev \
            libffi-dev \
            libsqlite3-dev \
            libbz2-dev \
            libreadline-dev \
            liblzma-dev \
            zlib1g-dev \
            openjdk-17-jdk \
            libusb-1.0-0 \
            libudev-dev \
            unzip \
            zip \
            wget \
            curl \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good

      - name: Установка Python и зависимостей
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install "buildozer==${BUILDOZER_VERSION}" "Cython==3.0.10" "kivy[base]==2.3.0"
          pip install -r requirements.txt

      - name: Подготовка ресурсов
        run: |
          mkdir -p assets
          # Генерация заглушек если нет реальных иконок
          if [ ! -f assets/icon.png ]; then
            convert -size 512x512 xc:#FFD700 -gravity center -pointsize 200 -fill '#0A0A0A' -annotate +0+0 "OM" assets/icon.png
          fi
          if [ ! -f assets/splash.png ]; then
            convert -size 1080x1920 xc:#0A0A0A -gravity center -pointsize 80 -fill '#FFD700' -annotate +0+0 "OrderManager" assets/splash.png
          fi

      - name: Кэширование .buildozer
        uses: actions/cache@v4
        with:
          path: |
            .buildozer
            ~/.gradle
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-
            ${{ runner.os }}-buildozer-

      - name: Очистка перед сборкой (если требуется)
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          rm -rf .buildozer
          buildozer android clean

      - name: Сборка приложения
        id: build
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
        run: |
          echo "=== Начало сборки ==="
          echo "Тип сборки: ${{ github.event.inputs.build_type || 'debug' }}"
          
          if [ "${{ github.event.inputs.build_type || 'debug' }}" == "release" ] && [ -z "${KEYSTORE_FILE}" ]; then
            echo "❌ Ошибка: Для релизной сборки требуется keystore в секретах!"
            exit 1
          fi
          
          # Сохранение keystore если есть
          if [ -n "${KEYSTORE_FILE}" ]; then
            echo "${KEYSTORE_FILE}" | base64 -d > release.keystore
            export P4A_RELEASE_KEYSTORE="$(pwd)/release.keystore"
            export P4A_RELEASE_KEYSTORE_PASSWD="${KEYSTORE_PASSWORD}"
            export P4A_RELEASE_KEYALIAS="${KEY_ALIAS}"
            export P4A_RELEASE_KEYALIAS_PASSWD="${KEY_ALIAS_PASSWORD}"
          fi
          
          # Сборка
          if [ "${{ github.event.inputs.build_type || 'debug' }}" == "release" ]; then
            echo "Сборка РЕЛИЗНОЙ версии..."
            buildozer -v android release
          else
            echo "Сборка ОТЛАДОЧНОЙ версии..."
            buildozer -v android debug
          fi
          
          # Поиск результата
          APK_FILE=$(find bin -name "*.apk" 2>/dev/null | head -n1)
          AAB_FILE=$(find bin -name "*.aab" 2>/dev/null | head -n1)
          
          if [ -n "$APK_FILE" ]; then
            echo "APK_FILE=$APK_FILE" >> $GITHUB_OUTPUT
            echo "ARTIFACT_NAME=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
            echo "ARTIFACT_TYPE=apk" >> $GITHUB_OUTPUT
            echo "✅ Найден APK: $APK_FILE"
          elif [ -n "$AAB_FILE" ]; then
            echo "APK_FILE=$AAB_FILE" >> $GITHUB_OUTPUT
            echo "ARTIFACT_NAME=$(basename $AAB_FILE)" >> $GITHUB_OUTPUT
            echo "ARTIFACT_TYPE=aab" >> $GITHUB_OUTPUT
            echo "✅ Найден AAB: $AAB_FILE"
          else
            echo "❌ Не найден результат сборки!"
            ls -la bin/
            exit 1
          fi

      - name: Загрузка артефакта
        uses: actions/upload-artifact@v4
        with:
          name: ordermanager-${{ steps.build.outputs.ARTIFACT_TYPE }}-${{ github.sha }}
          path: ${{ steps.build.outputs.APK_FILE }}
          retention-days: 30

      - name: Создание релиза (только для релизных сборок)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: OrderManager v${{ github.run_number }}
          body: |
            ## OrderManager Release Build
            
            **Сборка:** ${{ github.sha }}
            **Дата:** ${{ github.event.head_commit.timestamp }}
            **Архитектура:** arm64-v8a
            **Android API:** 34
            
            ✅ Полностью совместимо с требованиями Google Play 2026
          files: ${{ steps.build.outputs.APK_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Отчет о статусе
        if: always()
        run: |
          echo "======================================"
          echo "СБОРКА ЗАВЕРШЕНА"
          echo "Статус: ${{ job.status }}"
          echo "Артефакт: ${{ steps.build.outputs.ARTIFACT_NAME }}"
          echo "======================================"
          if [ "${{ job.status }}" != "success" ]; then
            echo "❌ Сборка завершилась с ошибкой"
            exit 1
          else
            echo "✅ Сборка успешно завершена!"
          fi
